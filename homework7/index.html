<script src="https://d3js.org/d3.v5.js"></script>

<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-collection.v1.min.js"></script>
<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-format.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-time.v1.min.js"></script>
<script src="https://d3js.org/d3-time-format.v2.min.js"></script>
<script src="https://d3js.org/d3-scale.v2.min.js"></script>
<script>

var x = d3.scaleLinear();

</script>

<h1>Demo of Bubble chart in D3</h1>

<svg>
    <text x=10 y=10>Bubble</text>
</svg>

<style>
    svg{
        width: 1500px;
        height: 1000px;
    }
</style>

<script>
    var data = [{
            'height': 170,
            'weight': 70,
        }, {
            'height': 160,
            'weight': 50,
        }, {
            'height': 180,
            'weight': 70,
        }, {
            'height': 180,
            'weight': 80,
        }, 
        {
            'height': 100,
            'weight': 40,
        },];

        var data2 = [{
            'height': 170,
            'weight': 70,
        }, {
            'height': 160,
            'weight': 70,
        }, {
            'height': 180,
            'weight': 90,
        }, {
            'height': 185,
            'weight': 70,
        }, 
        {
            'height': 150,
            'weight': 80,
        },];

        var dataset = [
    [2001, [{
        'height': 170,
        'weight': 70,
    }, {
        'height': 160,
        'weight': 50,
    }, {
        'height': 180,
        'weight': 70,
    }, {
        'height': 180,
        'weight': 80,
    }, {
        'height': 100,
        'weight': 40,
    }, ]],
    [2002, [{
        'height': 170,
        'weight': 70,
    }, {
        'height': 160,
        'weight': 50,
    }, {
        'height': 180,
        'weight': 70,
    }, {
        'height': 180,
        'weight': 80,
    }, {
        'height': 120,
        'weight': 80,
    }, ]],
    [2003, [{
        'height': 180,
        'weight': 70,
    }, {
        'height': 170,
        'weight': 50,
    }, {
        'height': 190,
        'weight': 70,
    }, {
        'height': 200,
        'weight': 80,
    }, {
        'height': 130,
        'weight': 80,
    }, ]],
    ]

    console.log(dataset);
     var frameHeight = 150;
     var yearLabel = svg.append("text") // year
        .attr("x", 20)
        .attr("y", 20)
        .attr("font-size", 50);

    svg
    .selectAll('circle') //select circle, bind elements to data
    .data(dataset[0][1]) //bind data
    .enter()
    .append('circle')
    .attr('cx', function(d) { //data=d, can be any thing
        return x(d['height']);
    })
      .attr('cy', function(d) {
        return y(d['weight']);
      // return frameHeight - d['weight'];
    })
    .attr('r', function(d) {
      // return d['weight']/10;
      return Math.sqrt (d['weight']); //change size of the circle according to the weight
    })
    .attr('fill', '#ff0000');

    yearLabel.text("2001")

    var keySnapshot = 0;
    d3.interval(function(){
        keySnapshot = (keySnapshot + 1) % dataset.length;
        svg 
    .selectAll('circle') 
    .data(dataset[keySnapshot][1]) 
    .transition() 
   // .duration(2000) 
    .attr('cx', function(d) { 
        return x(d['height']);
    })
      .attr('cy', function(d) {
        return y(d['weight']);
      // return frameHeight - d['weight'];
    })
    .attr('r', function(d) {
      return d['weight']/10;
     // return Math.sqrt (d['weight']); 
    })
    .attr('fill', '#00ff00');

    yearLabel.text(""  + dataset[keySnapshot][0]); // loop year

    }, 1000)
</script>

<!-- <script>
        var svg= d3.select('svg');
        // svg.remove();
        var data = [{
                'height': 170,
                'weight': 70,
            }, {
                'height': 160,
                'weight': 50,
            }, {
                'height': 180,
                'weight': 70,
            }, {
                'height': 180,
                'weight': 80,
            }, ];
        // svg.append('circle').attr('cx', 170).attr('cy', 70).attr('r', 10)
        // svg.append('circle').attr('cx', 160).attr('cy', 50).attr('r', 10)
        // svg.append('circle').attr('cx', 180).attr('cy', 70).attr('r', 10)
        // svg.append('circle').attr('cx', 180).attr('cy', 80).attr('r', 10)
        var frameHeight = 150;
        for (i=0; i < data.length; i++) {
        var x = data[i]['height'];
        var y = frameHeight - data[i]['weight'];
        svg.append('circle').attr('cx', x).attr('cy', y).attr('r', 5);
        }
    </script> -->


// try
(function() {

  // Fake JSON data
  var json = {"countries_msg_vol": {
    "CA": 170, "US": 393, "BB": 12, "CU": 9, "BR": 89, "MX": 192, "PY": 32, "UY": 9, "VE": 25, "BG": 42, "CZ": 12, "HU": 7, "RU": 184, "FI": 42, "GB": 162, "IT": 87, "ES": 65, "FR": 42, "DE": 102, "NL": 12, "CN": 92, "JP": 65, "KR": 87, "TW": 9, "IN": 98, "SG": 32, "ID": 4, "MY": 7, "VN": 8, "AU": 129, "NZ": 65, "GU": 11, "EG": 18, "LY": 4, "ZA": 76, "A1": 2, "Other": 254 
  }};
  
	// D3 Bubble Chart 

	var diameter = 600;

	var svg = d3.select('#graph').append('svg')
					.attr('width', diameter)
					.attr('height', diameter);

	var bubble = d3.layout.pack()
				.size([diameter, diameter])
				.value(function(d) {return d.size;})
         // .sort(function(a, b) {
				// 	return -(a.value - b.value)
				// }) 
				.padding(3);
  
  // generate data with calculated layout values
  var nodes = bubble.nodes(processData(json))
						.filter(function(d) { return !d.children; }); // filter out the outer bubble
 
  var vis = svg.selectAll('circle')
					.data(nodes);
  
  vis.enter().append('circle')
			.attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; })
			.attr('r', function(d) { return d.r; })
			.attr('class', function(d) { return d.className; });
  
  function processData(data) {
    var obj = data.countries_msg_vol;

    var newDataSet = [];

    for(var prop in obj) {
      newDataSet.push({name: prop, className: prop.toLowerCase(), size: obj[prop]});
    }
    return {children: newDataSet};
  }
  
})();
    
    
